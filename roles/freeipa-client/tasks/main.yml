---
- name: Install FreeIPA client packages
  ansible.builtin.dnf:
    name: "{{ freeipa_client_packages }}"
    state: present
  retries: 3
  delay: 5

- name: Check if already enrolled
  ansible.builtin.stat:
    path: /etc/ipa/default.conf
  register: ipa_client_configured

- name: Configure /etc/hosts for IPA server
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: '^\s*\d+\.\d+\.\d+\.\d+\s+{{ freeipa_server | regex_escape() }}(\s|$)'
    line: "{{ hostvars['head01']['ansible_host'] }} {{ freeipa_server }} head01"
    state: present

- name: Verify IPA server DNS resolution
  ansible.builtin.command: host {{ freeipa_server }}
  register: dns_check
  changed_when: false
  failed_when: false

- name: Install IPA client
  ansible.builtin.command: >
    ipa-client-install
    --server={{ freeipa_server }}
    --domain={{ freeipa_domain }}
    --realm={{ freeipa_realm }}
    --principal=admin
    --password={{ freeipa_admin_password }}
    --hostname={{ ansible_fqdn }}
    --mkhomedir
    --no-ntp
    --force-join
    --unattended
  when: not ipa_client_configured.stat.exists
  register: ipa_client_install
  async: 600
  poll: 10

- name: Configure authselect for mkhomedir
  ansible.builtin.command: authselect select sssd with-mkhomedir
  register: authselect_result
  changed_when: "'Profile was selected' in authselect_result.stdout"
  failed_when: authselect_result.rc != 0

- name: Enable and start oddjobd
  ansible.builtin.systemd:
    name: oddjobd
    state: started
    enabled: yes

- name: Enable and start SSSD
  ansible.builtin.systemd:
    name: sssd
    state: started
    enabled: yes

- name: Ensure sudo uses SSSD (sudo rules from FreeIPA)
  ansible.builtin.lineinfile:
    path: /etc/nsswitch.conf
    regexp: '^sudoers:'
    line: 'sudoers: files sss'
  register: nsswitch_sudoers

- name: Restart SSSD to apply nsswitch sudoers change
  ansible.builtin.systemd:
    name: sssd
    state: restarted
  when: nsswitch_sudoers is changed

- name: Clear SSSD cache (sudo rules)
  ansible.builtin.command: sss_cache -E
  when: nsswitch_sudoers is changed
  changed_when: false
  failed_when: false

- name: Clear SSSD cache
  ansible.builtin.command: sss_cache -E
  when: ipa_client_install is changed
  changed_when: false
  failed_when: false

- name: Restart SSSD to apply changes
  ansible.builtin.systemd:
    name: sssd
    state: restarted
  when: ipa_client_install is changed
