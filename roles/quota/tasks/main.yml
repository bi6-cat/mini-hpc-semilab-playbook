---
- name: Verify quota is enabled in configuration
  ansible.builtin.assert:
    that:
      - quota_enabled | default(false) | bool
    fail_msg: "quota_enabled must be true to use quota role"

- name: Detect filesystem type for quota path
  ansible.builtin.command: "findmnt -T {{ quota_path }} -no TARGET,FSTYPE"
  register: quota_findmnt
  changed_when: false

- name: Parse mount target and filesystem type
  ansible.builtin.set_fact:
    quota_mount_target: "{{ (quota_findmnt.stdout.split())[0] }}"
    quota_fstype: "{{ (quota_findmnt.stdout.split())[1] }}"

- name: Get current mount options from /proc/mounts
  ansible.builtin.shell: "grep ' {{ quota_mount_target }} ' /proc/mounts | awk '{print $4}'"
  register: quota_current_opts
  changed_when: false

- name: Determine required quota mount options
  ansible.builtin.set_fact:
    quota_required_opts: "{{ 'uquota,gquota' if quota_fstype == 'xfs' else 'usrquota,grpquota' }}"

- name: Check if remount is required
  ansible.builtin.set_fact:
    quota_needs_remount: >-
      {{ (quota_fstype == 'xfs' and ('uquota' not in quota_current_opts.stdout or 'gquota' not in quota_current_opts.stdout))
         or (quota_fstype in ['ext2','ext3','ext4'] and ('usrquota' not in quota_current_opts.stdout or 'grpquota' not in quota_current_opts.stdout)) }}

- name: Display quota configuration
  ansible.builtin.debug:
    msg:
      - "Mount: {{ quota_mount_target }}"
      - "Filesystem: {{ quota_fstype }}"
      - "Current options: {{ quota_current_opts.stdout }}"
      - "Required: {{ quota_required_opts }}"
      - "Remount needed: {{ quota_needs_remount }}"

- name: Check XFS quota support
  ansible.builtin.command: "xfs_info {{ quota_mount_target }}"
  register: xfs_info_output
  changed_when: false
  when: quota_fstype == 'xfs'

- name: Check filesystem usage before unmount (XFS only)
  ansible.builtin.command: "lsof +f -- {{ quota_mount_target }}"
  register: quota_lsof
  changed_when: false
  failed_when: false
  when:
    - quota_needs_remount | bool
    - quota_fstype == 'xfs'

- name: Warn if filesystem is busy (requires reboot)
  ansible.builtin.debug:
    msg:
      - "WARNING: {{ quota_mount_target }} has {{ quota_lsof.stdout_lines | length }} active processes"
      - "Cannot unmount for quota activation."
      - "Options: 1) Reboot storage node  2) Kill processes: fuser -km {{ quota_mount_target }}"
      - "/etc/fstab will be updated. Quota activates after reboot."
  when:
    - quota_needs_remount | bool
    - quota_fstype == 'xfs'
    - quota_lsof.rc == 0
    - quota_lsof.stdout | length > 0

- name: Unmount filesystem for quota enablement (XFS)
  ansible.builtin.command: "umount {{ quota_mount_target }}"
  when:
    - quota_needs_remount | bool
    - quota_fstype == 'xfs'
    - quota_lsof.rc != 0 or quota_lsof.stdout | length == 0
  register: quota_umount
  changed_when: true

- name: Remount with quota options (XFS)
  ansible.builtin.command: "mount {{ quota_mount_target }}"
  when:
    - quota_needs_remount | bool
    - quota_fstype == 'xfs'
    - quota_umount is changed
  register: quota_mount
  changed_when: true

- name: Remount with quota options (ext filesystems)
  ansible.builtin.command: "mount -o remount,{{ quota_required_opts }} {{ quota_mount_target }}"
  when:
    - quota_needs_remount | bool
    - quota_fstype in ['ext2','ext3','ext4']
  register: quota_remount
  changed_when: true

- name: Verify mount options after remount
  ansible.builtin.shell: "grep ' {{ quota_mount_target }} ' /proc/mounts | awk '{print $4}'"
  register: quota_verify_opts
  changed_when: false
  when: quota_needs_remount | bool

- name: Verify XFS quota state
  ansible.builtin.command: "xfs_quota -x -c 'state' {{ quota_mount_target }}"
  register: xfs_quota_state
  changed_when: false
  when:
    - quota_fstype == 'xfs'
    - (quota_mount is changed or quota_remount is changed)

- name: Identify mount in /etc/fstab
  ansible.builtin.shell: "grep -E '^[^#].*\\s{{ quota_mount_target }}\\s' /etc/fstab || true"
  register: quota_fstab_line
  changed_when: false

- name: Parse current /etc/fstab options for mount target
  ansible.builtin.set_fact:
    quota_fstab_opts: >-
      {{ (((quota_fstab_line.stdout_lines | default([]) | first | default('')).split())[3]
          if (((quota_fstab_line.stdout_lines | default([]) | first | default('')).split()) | length > 3)
          else '') }}
  when:
    - quota_fstab_line.stdout | length > 0

- name: Compute missing quota options for /etc/fstab
  ansible.builtin.set_fact:
    quota_fstab_append_opts: >-
      {{ (
          (['uquota'] if (quota_fstype == 'xfs' and 'uquota' not in quota_fstab_opts) else [])
          + (['gquota'] if (quota_fstype == 'xfs' and 'gquota' not in quota_fstab_opts) else [])
          + (['usrquota'] if (quota_fstype in ['ext2','ext3','ext4'] and 'usrquota' not in quota_fstab_opts) else [])
          + (['grpquota'] if (quota_fstype in ['ext2','ext3','ext4'] and 'grpquota' not in quota_fstab_opts) else [])
        ) | join(',') }}
  when:
    - quota_fstab_line.stdout | length > 0

- name: Persist quota options in /etc/fstab
  ansible.builtin.replace:
    path: /etc/fstab
    regexp: "^([^#\\n]*\\s{{ quota_mount_target }}\\s+[^\\s]+\\s+)([^\\s]+)(\\s+.*)$"
    replace: "\\1\\2,{{ quota_fstab_append_opts }}\\3"
  when:
    - quota_persist_fstab | default(true) | bool
    - quota_fstab_line.stdout | length > 0
    - quota_needs_remount | bool
    - quota_fstab_append_opts | default('') | length > 0

- name: Initialize ext quota database
  ansible.builtin.command: "quotacheck -cugm {{ quota_mount_target }}"
  when:
    - quota_initialize_ext_filesystems | default(true) | bool
    - quota_fstype in ['ext2','ext3','ext4']
  changed_when: false
  failed_when: false

- name: Enable ext filesystem quotas
  ansible.builtin.command: "quotaon -ug {{ quota_mount_target }}"
  when: quota_fstype in ['ext2','ext3','ext4']
  changed_when: false
  failed_when: false

- name: Verify quota is active
  ansible.builtin.set_fact:
    quota_is_active: "{{ ('usrquota' in quota_verify_opts.stdout or 'uquota' in quota_verify_opts.stdout) and ('grpquota' in quota_verify_opts.stdout or 'gquota' in quota_verify_opts.stdout) if quota_verify_opts is defined and quota_verify_opts.stdout is defined else ('usrquota' in quota_current_opts.stdout or 'uquota' in quota_current_opts.stdout) and ('grpquota' in quota_current_opts.stdout or 'gquota' in quota_current_opts.stdout) }}"

- name: Apply group quotas (XFS)
  ansible.builtin.command: >
    xfs_quota -x -c
    "limit -g bsoft={{ item.soft_gb }}g bhard={{ item.hard_gb }}g {{ item.groupname }}"
    {{ quota_mount_target }}
  loop: "{{ quota_group_limits | default([]) }}"
  loop_control:
    label: "{{ item.groupname }}"
  when:
    - quota_fstype == 'xfs'
    - (quota_group_limits | default([])) | length > 0
    - quota_is_active | bool
  changed_when: false

- name: Warn if quota not yet active
  ansible.builtin.debug:
    msg:
      - "WARNING: Quota not active on {{ quota_mount_target }}"
      - "Current: {{ quota_current_opts.stdout }}"
      - "Required: usrquota,grpquota (or uquota,gquota for XFS)"
      - "If /etc/fstab was updated, reboot and re-run playbook."
  when:
    - not (quota_is_active | bool)
    - (quota_group_limits | default([])) | length > 0

- name: Apply group quotas (ext2/3/4)
  ansible.builtin.command: >
    setquota -g {{ item.groupname }}
    {{ (item.soft_gb | int) * 1024 * 1024 }}
    {{ (item.hard_gb | int) * 1024 * 1024 }}
    0 0 {{ quota_mount_target }}
  loop: "{{ quota_group_limits | default([]) }}"
  loop_control:
    label: "{{ item.groupname }}"
  when:
    - quota_fstype in ['ext2','ext3','ext4']
    - (quota_group_limits | default([])) | length > 0
  changed_when: false

# Optional per-user quota (overrides group)
- name: Apply per-user quotas (XFS)
  ansible.builtin.command: >
    xfs_quota -x -c
    "limit -u bsoft={{ item.soft_gb }}g bhard={{ item.hard_gb }}g {{ item.username }}"
    {{ quota_mount_target }}
  loop: "{{ quota_user_limits | default([]) }}"
  loop_control:
    label: "{{ item.username }}"
  when:
    - quota_fstype == 'xfs'
    - (quota_user_limits | default([])) | length > 0
  changed_when: false

- name: Apply per-user quotas (ext2/3/4)
  ansible.builtin.command: >
    setquota -u {{ item.username }}
    {{ (item.soft_gb | int) * 1024 * 1024 }}
    {{ (item.hard_gb | int) * 1024 * 1024 }}
    0 0 {{ quota_mount_target }}
  loop: "{{ quota_user_limits | default([]) }}"
  loop_control:
    label: "{{ item.username }}"
  when:
    - quota_fstype in ['ext2','ext3','ext4']
    - (quota_user_limits | default([])) | length > 0
  changed_when: false

- name: Display quota summary
  ansible.builtin.debug:
    msg:
      - "Quota status: {{ 'active' if quota_is_active else 'inactive' }} on {{ quota_mount_target }} ({{ quota_fstype }})"
      - "Group limits: {{ quota_group_limits | default([]) | length }}"
      - "User limits: {{ quota_user_limits | default([]) | length }}"