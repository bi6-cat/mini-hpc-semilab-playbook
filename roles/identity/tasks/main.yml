---
- name: Wait for FreeIPA HTTPS service
  ansible.builtin.wait_for:
    port: 443
    host: "{{ ansible_fqdn }}"
    timeout: 120

- name: Destroy existing Kerberos tickets
  ansible.builtin.command: kdestroy -A
  changed_when: false
  failed_when: false

- name: Obtain Kerberos TGT for admin
  ansible.builtin.shell: echo "{{ freeipa_admin_password }}" | kinit admin
  changed_when: false
  no_log: true

- name: Check if admin group exists
  ansible.builtin.command: ipa group-show {{ admin_group }}
  register: group_check
  changed_when: false
  failed_when: false

- name: Create HPC admin group
  ansible.builtin.command: >
    ipa group-add {{ admin_group }}
    --desc='HPC Administrators'
  when: group_check.rc != 0

- name: Check if admin user exists
  ansible.builtin.command: ipa user-show {{ admin_user }}
  register: user_check
  changed_when: false
  failed_when: false

- name: Create admin user with password
  ansible.builtin.expect:
    command: >
      ipa user-add {{ admin_user }}
      --first=HPC
      --last=Administrator
      --email={{ admin_user }}@{{ freeipa_domain }}
      --shell=/bin/bash
      --password
    responses:
      "Password": "{{ freeipa_admin_password }}"
      "Enter Password again to verify": "{{ freeipa_admin_password }}"
  when: user_check.rc != 0
  no_log: false

- name: Add admin user to admin group
  ansible.builtin.command: ipa group-add-member {{ admin_group }} --users={{ admin_user }}
  register: group_member_result
  failed_when:
    - group_member_result.rc != 0
    - "'already a member' not in group_member_result.stdout"
  changed_when: "'Number of members added 1' in group_member_result.stdout"

- name: Check if sudo rule exists
  ansible.builtin.command: ipa sudorule-show {{ sudo_rule_name | default('hpc-admins') }}
  register: sudorule_check
  changed_when: false
  failed_when: false

- name: Create sudo rule for admin group
  ansible.builtin.command: >
    ipa sudorule-add {{ sudo_rule_name | default('hpc-admins') }}
    --desc='Unrestricted sudo for HPC administrators'
  when: sudorule_check.rc != 0

- name: Check sudo rule configuration
  ansible.builtin.command: ipa sudorule-show {{ sudo_rule_name | default('hpc-admins') }} --all
  register: sudorule_details
  changed_when: false
  failed_when: false
  when: sudorule_check.rc == 0

- name: Configure sudo rule for group membership
  ansible.builtin.command: ipa sudorule-add-user {{ sudo_rule_name | default('hpc-admins') }} --groups={{ admin_group }}
  when: sudorule_check.rc == 0 and admin_group not in sudorule_details.stdout
  register: sudo_user_result
  changed_when: true

- name: Configure sudo rule to allow all commands
  ansible.builtin.command: ipa sudorule-mod {{ sudo_rule_name | default('hpc-admins') }} --cmdcat=all
  register: sudo_cmd_result
  changed_when: "'Modified' in sudo_cmd_result.stdout"
  failed_when: false

- name: Configure sudo rule to allow all hosts
  ansible.builtin.command: ipa sudorule-mod {{ sudo_rule_name | default('hpc-admins') }} --hostcat=all
  register: sudo_host_result
  changed_when: "'Modified' in sudo_host_result.stdout"
  failed_when: false

- name: Check sudo rule status
  ansible.builtin.command: ipa sudorule-show {{ sudo_rule_name | default('hpc-admins') }}
  register: sudo_rule_info
  changed_when: false

- name: Enable sudo rule
  ansible.builtin.command: ipa sudorule-enable {{ sudo_rule_name | default('hpc-admins') }}
  when: "'Enabled: True' not in sudo_rule_info.stdout"  
  changed_when: true

# Create user groups (lecture, stu, guest)
- name: Check if user groups exist
  ansible.builtin.command: ipa group-show {{ item.name }}
  loop: "{{ user_groups }}"
  register: user_groups_check
  changed_when: false
  failed_when: false
  when: user_groups is defined

- name: Create user groups
  ansible.builtin.command: >
    ipa group-add {{ item.item.name }}
    --desc='{{ item.item.description }}'
    --gid={{ item.item.gid }}
  loop: "{{ user_groups_check.results }}"
  when: 
    - user_groups is defined
    - item.rc != 0
  loop_control:
    label: "{{ item.item.name }}"

- name: Deploy /home directory on NFS storage
  ansible.builtin.file:
    path: "{{ nfs_home }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  delegate_to: "{{ groups['storage'][0] }}"
  when: user_groups is defined

- name: Create shared directories in /home
  ansible.builtin.file:
    path: "{{ nfs_home }}/{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop:
    - tools
    - software
    - docs
  delegate_to: "{{ groups['storage'][0] }}"

- name: Create group home directories on NFS storage
  ansible.builtin.file:
    path: "{{ nfs_home }}/{{ item.name }}"
    state: directory
    owner: root
    group: "{{ item.gid }}"
    mode: '0711'
  loop: "{{ user_groups }}"
  when: user_groups is defined
  delegate_to: "{{ groups['storage'][0] }}"

- name: Check if HBAC rules exist for user groups
  ansible.builtin.command: ipa hbacrule-show hbac-{{ item.name }}
  loop: "{{ user_groups }}"
  register: hbac_rules_check
  changed_when: false
  failed_when: false
  when: user_groups is defined

- name: Create HBAC rules for user groups
  ansible.builtin.command: >
    ipa hbacrule-add hbac-{{ item.item.name }}
    --desc='Access rule for {{ item.item.description }}'
  loop: "{{ hbac_rules_check.results }}"
  when:
    - user_groups is defined
    - item.rc != 0
  loop_control:
    label: "{{ item.item.name }}"

- name: Add user groups to HBAC rules
  ansible.builtin.command: >
    ipa hbacrule-add-user hbac-{{ item.name }}
    --groups={{ item.name }}
  loop: "{{ user_groups }}"
  register: hbac_add_group
  failed_when:
    - hbac_add_group.rc != 0
    - "'already a member' not in hbac_add_group.stdout"
  changed_when: "'Number of members added 1' in hbac_add_group.stdout"
  when: user_groups is defined

- name: Configure HBAC rules for user group access by node type
  ansible.builtin.shell: |
    {% for node_type in item.login_nodes %}
    ipa hbacrule-add-host hbac-{{ item.name }} --hostgroups={{ node_type }} 2>/dev/null || true
    {% endfor %}
  loop: "{{ user_groups }}"
  register: hbac_add_hosts
  changed_when: false
  when: user_groups is defined

- name: Display identity configuration status
  ansible.builtin.debug:
    msg:
      - "Admin group: {{ admin_group }}"
      - "Admin user: {{ admin_user }}"
      - "Sudo rule: {{ sudo_rule_name | default('hpc-admins') }}"
      - "User groups: {{ user_groups | map(attribute='name') | list | join(', ') if user_groups is defined else 'none' }}"