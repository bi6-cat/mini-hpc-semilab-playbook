---
- name: Assert GUI is enabled
  ansible.builtin.assert:
    that:
      - gui_enabled | default(false) | bool
    fail_msg: "GUI not enabled for this host (set gui_enabled: true)"

- name: Install EPEL repository
  ansible.builtin.dnf:
    name: epel-release
    state: present

- name: Install dnf plugins
  ansible.builtin.dnf:
    name: dnf-plugins-core
    state: present

- name: Enable PowerTools repository
  ansible.builtin.command: "dnf config-manager --set-enabled {{ gui_powertools_repo }}"
  changed_when: false

- name: Install Xorg base packages
  ansible.builtin.dnf:
    name: "{{ gui_xorg_packages }}"
    state: present

- name: Install XFCE desktop packages
  ansible.builtin.dnf:
    name: "{{ gui_xfce_packages }}"
    state: present
  when: xfce_enabled | default(true) | bool

- name: Create global XFCE session launcher
  ansible.builtin.copy:
    dest: /etc/skel/.Xclients
    content: |
      #!/bin/bash
      exec /usr/bin/startxfce4
    owner: root
    group: root
    mode: '0755'
  when: xfce_enabled | default(true) | bool

- name: Ensure global xfconf defaults directory exists
  ansible.builtin.file:
    path: /etc/xdg/xfce4/xfconf/xfce-perchannel-xml
    state: directory
    owner: root
    group: root
    mode: '0755'
  when:
    - xfce_enabled | default(true) | bool
    - gui_xfce_tuning_enabled | bool

- name: Ensure skel xfconf directory exists for new users
  ansible.builtin.file:
    path: /etc/skel/.config/xfce4/xfconf/xfce-perchannel-xml
    state: directory
    owner: root
    group: root
    mode: '0755'
  when:
    - xfce_enabled | default(true) | bool
    - gui_xfce_tuning_enabled | bool

- name: Assert branding image source is provided
  ansible.builtin.assert:
    that:
      - (gui_branding_logo_src | default('') | length) > 0
    fail_msg: "Branding enabled but no logo source provided. Set gui_branding_logo_src (role file under roles/login-gui/files/...)."
  when:
    - gui_branding_enabled | default(false) | bool

- name: Ensure branding wallpaper directory exists
  ansible.builtin.file:
    path: "{{ gui_branding_wallpaper_path | dirname }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  when:
    - gui_branding_enabled | default(false) | bool

- name: Deploy branding wallpaper from role file
  ansible.builtin.copy:
    src: "{{ gui_branding_logo_src }}"
    dest: "{{ gui_branding_wallpaper_path }}"
    owner: root
    group: root
    mode: '0644'
  when:
    - gui_branding_enabled | default(false) | bool

- name: Disable XFWM compositor (global defaults)
  ansible.builtin.template:
    src: xfwm4.xml.j2
    dest: /etc/xdg/xfce4/xfconf/xfce-perchannel-xml/xfwm4.xml
    owner: root
    group: root
    mode: '0644'
  when:
    - xfce_enabled | default(true) | bool
    - gui_xfce_tuning_enabled | bool

- name: Disable XFWM compositor (skel for new users)
  ansible.builtin.template:
    src: xfwm4.xml.j2
    dest: /etc/skel/.config/xfce4/xfconf/xfce-perchannel-xml/xfwm4.xml
    owner: root
    group: root
    mode: '0644'
  when:
    - xfce_enabled | default(true) | bool
    - gui_xfce_tuning_enabled | bool

- name: Simplify desktop backdrop (global defaults)
  ansible.builtin.template:
    src: xfce4-desktop.xml.j2
    dest: /etc/xdg/xfce4/xfconf/xfce-perchannel-xml/xfce4-desktop.xml
    owner: root
    group: root
    mode: '0644'
  when:
    - xfce_enabled | default(true) | bool
    - gui_xfce_tuning_enabled | bool

- name: Simplify desktop backdrop (skel for new users)
  ansible.builtin.template:
    src: xfce4-desktop.xml.j2
    dest: /etc/skel/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-desktop.xml
    owner: root
    group: root
    mode: '0644'
  when:
    - xfce_enabled | default(true) | bool
    - gui_xfce_tuning_enabled | bool

- name: Disable XFCE screensaver/lock (global defaults)
  ansible.builtin.template:
    src: xfce4-screensaver.xml.j2
    dest: /etc/xdg/xfce4/xfconf/xfce-perchannel-xml/xfce4-screensaver.xml
    owner: root
    group: root
    mode: '0644'
  when:
    - xfce_enabled | default(true) | bool
    - gui_xfce_tuning_enabled | bool
    - gui_xfce_screensaver_tuning_enabled | default(true) | bool

- name: Disable XFCE screensaver/lock (skel for new users)
  ansible.builtin.template:
    src: xfce4-screensaver.xml.j2
    dest: /etc/skel/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-screensaver.xml
    owner: root
    group: root
    mode: '0644'
  when:
    - xfce_enabled | default(true) | bool
    - gui_xfce_tuning_enabled | bool
    - gui_xfce_screensaver_tuning_enabled | default(true) | bool

- name: Configure XFCE power manager (global defaults)
  ansible.builtin.template:
    src: xfce4-power-manager.xml.j2
    dest: /etc/xdg/xfce4/xfconf/xfce-perchannel-xml/xfce4-power-manager.xml
    owner: root
    group: root
    mode: '0644'
  when:
    - xfce_enabled | default(true) | bool
    - gui_xfce_tuning_enabled | bool
    - gui_xfce_power_manager_tuning_enabled | default(true) | bool

- name: Configure XFCE power manager (skel for new users)
  ansible.builtin.template:
    src: xfce4-power-manager.xml.j2
    dest: /etc/skel/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-power-manager.xml
    owner: root
    group: root
    mode: '0644'
  when:
    - xfce_enabled | default(true) | bool
    - gui_xfce_tuning_enabled | bool
    - gui_xfce_power_manager_tuning_enabled | default(true) | bool

- name: Install X2Go server packages
  ansible.builtin.dnf:
    name: "{{ gui_x2go_packages }}"
    state: present
  when: x2go_enabled | default(true) | bool

- name: Ensure /etc/x2go exists
  ansible.builtin.file:
    path: /etc/x2go
    state: directory
    owner: root
    group: root
    mode: '0755'
  when: x2go_enabled | default(true) | bool

- name: Ensure X2Go Xsession script
  ansible.builtin.template:
    src: x2go-Xsession.j2
    dest: /etc/x2go/Xsession
    owner: root
    group: root
    mode: '0755'
  when: x2go_enabled | default(true) | bool

- name: Ensure multi-user target
  ansible.builtin.command: systemctl set-default multi-user.target
  changed_when: false

- name: Ensure X11 forwarding enabled in sshd_config
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?X11Forwarding'
    line: 'X11Forwarding yes'
    state: present
  notify: Restart sshd

- name: Ensure SSH client alive (keepalive) settings
  ansible.builtin.blockinfile:
    path: /etc/ssh/sshd_config
    marker: "# {mark} ANSIBLE MANAGED: x2go keepalive"
    block: |
      ClientAliveInterval {{ gui_x2go_ssh_client_alive_interval }}
      ClientAliveCountMax {{ gui_x2go_ssh_client_alive_countmax }}
  notify: Restart sshd
  when:
    - x2go_enabled | default(true) | bool
    - gui_x2go_ssh_keepalive_enabled | default(true) | bool

- name: Verify XFCE is installed
  ansible.builtin.command: which startxfce4
  changed_when: false
  when: xfce_enabled | default(true) | bool

- name: Sync XFCE skel to storage node for new user creation
  ansible.posix.synchronize:
    src: /etc/skel/.config/
    dest: /etc/skel/.config/
    rsync_opts:
      - "--chmod=D755,F644"
  delegate_to: "{{ groups['storage'][0] }}"
  when:
    - xfce_enabled | default(true) | bool
    - groups['storage'] is defined
    - groups['storage'] | length > 0

- name: Sync XFCE Xclients to storage node
  ansible.posix.synchronize:
    src: /etc/skel/.Xclients
    dest: /etc/skel/.Xclients
    rsync_opts:
      - "--chmod=755"
  delegate_to: "{{ groups['storage'][0] }}"
  when:
    - xfce_enabled | default(true) | bool
    - groups['storage'] is defined
    - groups['storage'] | length > 0
