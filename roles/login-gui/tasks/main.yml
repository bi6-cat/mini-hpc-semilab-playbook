---
- name: Assert GUI is enabled
  ansible.builtin.assert:
    that:
      - gui_enabled | default(false) | bool
    fail_msg: "GUI not enabled for this host (set gui_enabled: true)"

- name: Install EPEL repository
  ansible.builtin.dnf:
    name: epel-release
    state: present

- name: Install dnf plugins
  ansible.builtin.dnf:
    name: dnf-plugins-core
    state: present

- name: Enable PowerTools repository
  ansible.builtin.command: "dnf config-manager --set-enabled {{ gui_powertools_repo }}"
  changed_when: false

- name: Install Xorg base packages
  ansible.builtin.dnf:
    name: "{{ gui_xorg_packages }}"
    state: present

- name: Install XFCE desktop packages
  ansible.builtin.dnf:
    name: "{{ gui_xfce_packages }}"
    state: present
  when: xfce_enabled | default(true) | bool

- name: Create global XFCE session launcher
  ansible.builtin.copy:
    dest: /etc/skel/.Xclients
    content: |
      #!/bin/bash
      exec /usr/bin/startxfce4
    owner: root
    group: root
    mode: '0755'
  when: xfce_enabled | default(true) | bool

- name: Ensure global xfconf defaults directory exists
  ansible.builtin.file:
    path: /etc/xdg/xfce4/xfconf/xfce-perchannel-xml
    state: directory
    owner: root
    group: root
    mode: '0755'
  when:
    - xfce_enabled | default(true) | bool
    - gui_xfce_tuning_enabled | bool

- name: Disable XFWM compositor (global defaults)
  ansible.builtin.template:
    src: xfwm4.xml.j2
    dest: /etc/xdg/xfce4/xfconf/xfce-perchannel-xml/xfwm4.xml
    owner: root
    group: root
    mode: '0644'
  when:
    - xfce_enabled | default(true) | bool
    - gui_xfce_tuning_enabled | bool

- name: Simplify desktop backdrop (global defaults)
  ansible.builtin.template:
    src: xfce4-desktop.xml.j2
    dest: /etc/xdg/xfce4/xfconf/xfce-perchannel-xml/xfce4-desktop.xml
    owner: root
    group: root
    mode: '0644'
  when:
    - xfce_enabled | default(true) | bool
    - gui_xfce_tuning_enabled | bool

- name: Lookup tune user 
  ansible.builtin.getent:
    database: passwd
    key: "{{ gui_xfce_tune_user }}"
  when:
    - xfce_enabled | default(true) | bool
    - gui_xfce_tuning_enabled | bool
    - gui_xfce_tune_user | length > 0

- name: Set facts for tune user
  ansible.builtin.set_fact:
    _gui_tune_home: "{{ getent_passwd[gui_xfce_tune_user][4] }}"
    _gui_tune_uid: "{{ getent_passwd[gui_xfce_tune_user][1] }}"
    _gui_tune_gid: "{{ getent_passwd[gui_xfce_tune_user][2] }}"
  when:
    - xfce_enabled | default(true) | bool
    - gui_xfce_tuning_enabled | bool
    - gui_xfce_tune_user | length > 0

- name: Ensure per-user xfconf directory exists
  ansible.builtin.file:
    path: "{{ _gui_tune_home }}/.config/xfce4/xfconf/xfce-perchannel-xml"
    state: directory
    owner: "{{ _gui_tune_uid }}"
    group: "{{ _gui_tune_gid }}"
    mode: '0700'
  when:
    - xfce_enabled | default(true) | bool
    - gui_xfce_tuning_enabled | bool
    - gui_xfce_tune_user | length > 0

- name: Disable compositor (tune user override)
  ansible.builtin.template:
    src: xfwm4.xml.j2
    dest: "{{ _gui_tune_home }}/.config/xfce4/xfconf/xfce-perchannel-xml/xfwm4.xml"
    owner: "{{ _gui_tune_uid }}"
    group: "{{ _gui_tune_gid }}"
    mode: '0600'
  when:
    - xfce_enabled | default(true) | bool
    - gui_xfce_tuning_enabled | bool
    - gui_xfce_tune_user | length > 0

- name: Disable wallpaper (tune user override)
  ansible.builtin.template:
    src: xfce4-desktop.xml.j2
    dest: "{{ _gui_tune_home }}/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-desktop.xml"
    owner: "{{ _gui_tune_uid }}"
    group: "{{ _gui_tune_gid }}"
    mode: '0600'
  when:
    - xfce_enabled | default(true) | bool
    - gui_xfce_tuning_enabled | bool
    - gui_xfce_tune_user | length > 0

- name: Install X2Go server packages
  ansible.builtin.dnf:
    name: "{{ gui_x2go_packages }}"
    state: present
  when: x2go_enabled | default(true) | bool

- name: Ensure /etc/x2go exists
  ansible.builtin.file:
    path: /etc/x2go
    state: directory
    owner: root
    group: root
    mode: '0755'
  when: x2go_enabled | default(true) | bool

- name: Ensure X2Go Xsession script
  ansible.builtin.copy:
    dest: /etc/x2go/Xsession
    content: |
      #!/bin/bash
      if [ -x ~/.Xclients ]; then
          exec ~/.Xclients
      elif [ -x /etc/skel/.Xclients ]; then
          exec /etc/skel/.Xclients
      else
          exec /usr/bin/startxfce4
      fi
    owner: root
    group: root
    mode: '0755'
  when: x2go_enabled | default(true) | bool

- name: Ensure multi-user target
  ansible.builtin.command: systemctl set-default multi-user.target
  changed_when: false

- name: Ensure X11 forwarding enabled in sshd_config
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?X11Forwarding'
    line: 'X11Forwarding yes'
    state: present
  notify: Restart sshd

- name: Verify XFCE is installed
  ansible.builtin.command: which startxfce4
  changed_when: false
  when: xfce_enabled | default(true) | bool
