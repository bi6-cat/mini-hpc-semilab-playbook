- name: 00 - Bootstrap all nodes
  hosts: all
  gather_facts: true
  become: true

  pre_tasks:
    - name: Ensure run as root
      ansible.builtin.fail:
        msg: "Must run as root"
      when: ansible_user_id != "root"

    - name: Test connectivity
      ansible.builtin.ping:

    - name: Verify Rocky Linux 8
      ansible.builtin.assert:
        that:
          - ansible_distribution == "Rocky"
          - ansible_distribution_major_version == "8"
        fail_msg: "Requires Rocky Linux 8"

  roles:
    - os
    - common
    - security

  post_tasks:
    - name: Verify sudo access
      ansible.builtin.command: sudo -n true
      become_user: ansible
      changed_when: false
      register: sudo_test

    - name: Bootstrap status
      ansible.builtin.debug:
        msg:
          - "✓ {{ inventory_hostname }} completed"
          - "✓ Hostname: {{ inventory_hostname }}.{{ domain_name }}"
          - "✓ SELinux: {{ selinux_mode.stdout }}"
          - "⚠ Next: Run with ansible user"