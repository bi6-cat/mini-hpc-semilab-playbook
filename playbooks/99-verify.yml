---
##############################################################################
# 99-verify.yml - Post-deployment verification for 00-bootstrap + 01-identity
##############################################################################

##############################################################################
# PART 1: Verify 00-bootstrap (OS baseline) - All hosts
##############################################################################
- name: "99 - Verify 00-bootstrap: OS baseline"
  hosts: all
  gather_facts: true
  become: true

  vars:
    expected_fqdn: "{{ inventory_hostname }}.{{ domain_name }}"

  tasks:
    # --- 1.1 Network & Hostname ---
    - name: "[00] Verify network connectivity"
      ansible.builtin.ping:

    - name: "[00] Verify FQDN"
      ansible.builtin.command: hostname -f
      register: fqdn_check
      changed_when: false

    - name: "[00] Assert hostname matches inventory + domain"
      ansible.builtin.assert:
        that:
          - fqdn_check.stdout == expected_fqdn
        fail_msg: "FQDN mismatch. Expected {{ expected_fqdn }}, got {{ fqdn_check.stdout }}"

    - name: "[00] Verify /etc/hosts contains cluster nodes"
      ansible.builtin.command: "grep -q '{{ item }}.{{ domain_name }}' /etc/hosts"
      loop: "{{ groups['all'] }}"
      changed_when: false

    # --- 1.2 Time & NTP ---
    - name: "[00] Verify chronyd is active"
      ansible.builtin.command: systemctl is-active chronyd
      register: chronyd_active
      changed_when: false
      failed_when: chronyd_active.stdout != 'active'

    - name: "[00] Verify timezone"
      ansible.builtin.command: timedatectl show --property=Timezone --value
      register: tz_check
      changed_when: false

    - name: "[00] Assert timezone is correct"
      ansible.builtin.assert:
        that:
          - tz_check.stdout == timezone
        fail_msg: "Timezone mismatch. Expected {{ timezone }}, got {{ tz_check.stdout }}"

    # --- 1.3 Firewall & Security ---
    - name: "[00] Verify firewalld is inactive"
      ansible.builtin.command: systemctl is-active firewalld
      register: firewalld_active
      changed_when: false
      failed_when: false

    - name: "[00] Verify SELinux mode"
      ansible.builtin.command: getenforce
      register: selinux_mode
      changed_when: false
      failed_when: false

    # --- 1.4 Users & Sudo ---
    - name: "[00] Verify ansible user exists"
      ansible.builtin.command: id ansible
      register: ansible_user_check
      changed_when: false

    - name: "[00] Verify sudoers drop-ins exist"
      ansible.builtin.stat:
        path: "{{ item }}"
      register: sudoers_files
      loop:
        - /etc/sudoers.d/ansible
        - /etc/sudoers.d/hpcadmin

    - name: "[00] Assert sudoers files present"
      ansible.builtin.assert:
        that:
          - item.stat.exists
        fail_msg: "Missing sudoers file: {{ item.item }}"
      loop: "{{ sudoers_files.results }}"
      loop_control:
        label: "{{ item.item }}"

    # --- 1.5 Summary ---
    - name: "[00] Display bootstrap verification summary"
      ansible.builtin.debug:
        msg:
          - "═══════════════════════════════════════"
          - "  00-BOOTSTRAP VERIFICATION: {{ inventory_hostname }}"
          - "═══════════════════════════════════════"
          - "  ✓ FQDN: {{ fqdn_check.stdout }}"
          - "  ✓ Timezone: {{ tz_check.stdout }}"
          - "  ✓ chronyd: {{ chronyd_active.stdout }}"
          - "  ✓ firewalld: {{ firewalld_active.stdout | default('unknown') }}"
          - "  ✓ SELinux: {{ selinux_mode.stdout | default('unknown') }}"
          - "  ✓ ansible user: exists"
          - "  ✓ sudoers: OK"


##############################################################################
# PART 2: Verify 01-identity - FreeIPA Server (head)
##############################################################################
- name: "99 - Verify 01-identity: FreeIPA Server"
  hosts: head
  gather_facts: true
  become: true

  tasks:
    # --- 2.1 IPA Services ---
    - name: "[01-server] Wait for FreeIPA web service"
      ansible.builtin.wait_for:
        host: "{{ ansible_fqdn }}"
        port: 443
        timeout: 60

    - name: "[01-server] Verify ipactl status"
      ansible.builtin.command: ipactl status
      register: ipactl_status
      changed_when: false
      failed_when: ipactl_status.rc != 0

    - name: "[01-server] Assert key IPA services are RUNNING"
      ansible.builtin.assert:
        that:
          - "'Directory Service: RUNNING' in ipactl_status.stdout"
          - "'krb5kdc Service: RUNNING' in ipactl_status.stdout"
          - "'kadmin Service: RUNNING' in ipactl_status.stdout"
          - "'named Service: RUNNING' in ipactl_status.stdout"
          - "'httpd Service: RUNNING' in ipactl_status.stdout"
        fail_msg: "FreeIPA services not healthy on {{ inventory_hostname }}"

    # --- 2.2 IPA Objects ---
    - name: "[01-server] Get Kerberos ticket for admin"
      ansible.builtin.shell: echo "{{ freeipa_admin_password }}" | kinit admin
      changed_when: false
      no_log: true

    - name: "[01-server] Verify admin user exists"
      ansible.builtin.command: ipa user-show {{ admin_user }}
      register: ipa_user_show
      changed_when: false

    - name: "[01-server] Verify admin group exists"
      ansible.builtin.command: ipa group-show {{ admin_group }}
      register: ipa_group_show
      changed_when: false

    - name: "[01-server] Verify user is member of group"
      ansible.builtin.command: ipa group-show {{ admin_group }} --all
      register: ipa_group_members
      changed_when: false

    - name: "[01-server] Assert user is in admin group"
      ansible.builtin.assert:
        that:
          - admin_user in ipa_group_members.stdout
        fail_msg: "User {{ admin_user }} is not member of {{ admin_group }}"

    - name: "[01-server] Verify sudo rule exists and enabled"
      ansible.builtin.command: ipa sudorule-show {{ sudo_rule_name | default('hpc-admins') }}
      register: ipa_sudorule_show
      changed_when: false

    - name: "[01-server] Assert sudo rule is enabled"
      ansible.builtin.assert:
        that:
          - "'Enabled: True' in ipa_sudorule_show.stdout"
        fail_msg: "Sudo rule {{ sudo_rule_name | default('hpc-admins') }} is not enabled"

    # --- 2.3 SSSD on Server ---
    - name: "[01-server] Verify SSSD is active"
      ansible.builtin.command: systemctl is-active sssd
      register: sssd_active
      changed_when: false
      failed_when: sssd_active.stdout != 'active'

    - name: "[01-server] Verify NSS lookup (id admin_user)"
      ansible.builtin.command: id {{ admin_user }}
      register: id_check
      changed_when: false

    # --- 2.4 Summary ---
    - name: "[01-server] Display FreeIPA server summary"
      ansible.builtin.debug:
        msg:
          - "═══════════════════════════════════════"
          - "  01-IDENTITY SERVER: {{ inventory_hostname }}"
          - "═══════════════════════════════════════"
          - "  ✓ FreeIPA services: ALL RUNNING"
          - "  ✓ SSSD: {{ sssd_active.stdout }}"
          - "  ✓ User: {{ admin_user }}"
          - "  ✓ Group: {{ admin_group }}"
          - "  ✓ Sudo rule: {{ sudo_rule_name | default('hpc-admins') }} (Enabled)"
          - "  ✓ NSS lookup: OK"


##############################################################################
# PART 3: Verify 01-identity - FreeIPA Clients (storage, login, compute)
##############################################################################
- name: "99 - Verify 01-identity: FreeIPA Clients"
  hosts: storage,login,compute
  gather_facts: true
  become: true

  tasks:
    # --- 3.1 Client Enrollment ---
    - name: "[01-client] Wait for FreeIPA server"
      ansible.builtin.wait_for:
        host: "{{ freeipa_server }}"
        port: 443
        timeout: 60

    - name: "[01-client] Verify client enrollment file exists"
      ansible.builtin.stat:
        path: /etc/ipa/default.conf
      register: ipa_default_conf

    - name: "[01-client] Assert client is enrolled"
      ansible.builtin.assert:
        that:
          - ipa_default_conf.stat.exists
        fail_msg: "/etc/ipa/default.conf missing; client not enrolled"

    # --- 3.2 SSSD Configuration ---
    - name: "[01-client] Verify SSSD is active"
      ansible.builtin.command: systemctl is-active sssd
      register: sssd_active
      changed_when: false
      failed_when: sssd_active.stdout != 'active'

    - name: "[01-client] Verify oddjobd is active (for mkhomedir)"
      ansible.builtin.command: systemctl is-active oddjobd
      register: oddjobd_active
      changed_when: false
      failed_when: oddjobd_active.stdout != 'active'

    - name: "[01-client] Verify nsswitch sudoers uses SSSD"
      ansible.builtin.command: "grep -E '^sudoers:.*\\bsss\\b' /etc/nsswitch.conf"
      register: nsswitch_sudoers
      changed_when: false
      failed_when: nsswitch_sudoers.rc != 0

    - name: "[01-client] Verify authselect profile"
      ansible.builtin.command: authselect current
      register: authselect_current
      changed_when: false
      failed_when: false

    - name: "[01-client] Assert authselect mkhomedir is enabled"
      ansible.builtin.assert:
        that:
          - authselect_current.stdout is search('with-mkhomedir')
        fail_msg: "authselect profile missing with-mkhomedir"

    # --- 3.3 Identity & Sudo ---
    - name: "[01-client] Verify NSS lookup from FreeIPA"
      ansible.builtin.command: id {{ admin_user }}
      register: id_check
      changed_when: false

    - name: "[01-client] Verify sudo rule applies to user"
      ansible.builtin.command: sudo -n -l -U {{ admin_user }}
      register: sudo_check
      changed_when: false
      failed_when: sudo_check.rc != 0

    - name: "[01-client] Assert sudo grants full access"
      ansible.builtin.assert:
        that:
          - sudo_check.stdout is search('\\(root\\) ALL')
        fail_msg: "FreeIPA sudo rule not applied for {{ admin_user }} on {{ inventory_hostname }}"

    # --- 3.4 Summary ---
    - name: "[01-client] Display client identity summary"
      ansible.builtin.debug:
        msg:
          - "═══════════════════════════════════════"
          - "  01-IDENTITY CLIENT: {{ inventory_hostname }}"
          - "═══════════════════════════════════════"
          - "  ✓ Enrolled to: {{ freeipa_server }}"
          - "  ✓ SSSD: {{ sssd_active.stdout }}"
          - "  ✓ oddjobd: {{ oddjobd_active.stdout }}"
          - "  ✓ nsswitch sudoers: sss"
          - "  ✓ authselect: with-mkhomedir"
          - "  ✓ id {{ admin_user }}: OK"
          - "  ✓ sudo for {{ admin_user }}: (root) ALL"


##############################################################################
# PART 4: Verify 02-storage - NFS Server (storage)
##############################################################################
- name: "99 - Verify 02-storage: NFS Server"
  hosts: storage
  gather_facts: true
  become: true

  tasks:
    # --- 4.1 NFS Services ---
    - name: "[02-server] Verify rpcbind is active"
      ansible.builtin.command: systemctl is-active rpcbind
      register: rpcbind_active
      changed_when: false
      failed_when: rpcbind_active.stdout != 'active'

    - name: "[02-server] Verify nfs-server is active"
      ansible.builtin.command: systemctl is-active nfs-server
      register: nfs_server_active
      changed_when: false
      failed_when: nfs_server_active.stdout != 'active'

    # --- 4.2 Exports ---
    - name: "[02-server] Get current exports"
      ansible.builtin.command: exportfs -v
      register: exportfs_output
      changed_when: false

    - name: "[02-server] Verify /home is exported"
      ansible.builtin.assert:
        that:
          - "'/home' in exportfs_output.stdout"
        fail_msg: "/home is not exported"

    - name: "[02-server] Verify /proj is exported"
      ansible.builtin.assert:
        that:
          - "'/proj' in exportfs_output.stdout"
        fail_msg: "/proj is not exported"

    - name: "[02-server] Verify /soft is exported"
      ansible.builtin.assert:
        that:
          - "'/soft' in exportfs_output.stdout"
        fail_msg: "/soft is not exported"

    # --- 4.3 Export directories exist and are accessible ---
    - name: "[02-server] Verify export directories exist"
      ansible.builtin.stat:
        path: "{{ item }}"
      register: export_dirs
      loop:
        - /home
        - /proj
        - /soft

    - name: "[02-server] Assert export directories exist"
      ansible.builtin.assert:
        that:
          - item.stat.exists
          - item.stat.isdir
        fail_msg: "Export directory {{ item.item }} does not exist"
      loop: "{{ export_dirs.results }}"
      loop_control:
        label: "{{ item.item }}"

    # --- 4.4 Test write to exports ---
    - name: "[02-server] Test write to /proj"
      ansible.builtin.file:
        path: /proj/.nfs_test_marker
        state: touch
        mode: '0644'
      changed_when: false

    - name: "[02-server] Test write to /soft"
      ansible.builtin.file:
        path: /soft/.nfs_test_marker
        state: touch
        mode: '0644'
      changed_when: false

    # --- 4.5 Summary ---
    - name: "[02-server] Display NFS server summary"
      ansible.builtin.debug:
        msg:
          - "═══════════════════════════════════════"
          - "  02-STORAGE NFS SERVER: {{ inventory_hostname }}"
          - "═══════════════════════════════════════"
          - "  ✓ rpcbind: {{ rpcbind_active.stdout }}"
          - "  ✓ nfs-server: {{ nfs_server_active.stdout }}"
          - "  ✓ Exports:"
          - "{{ exportfs_output.stdout_lines | to_nice_yaml }}"


##############################################################################
# PART 5: Verify 02-storage - NFS Clients (head, login, compute)
##############################################################################
- name: "99 - Verify 02-storage: NFS Clients"
  hosts: head,login,compute
  gather_facts: true
  become: true

  tasks:
    # --- 5.1 NFS client package ---
    - name: "[02-client] Verify nfs-utils installed"
      ansible.builtin.command: rpm -q nfs-utils
      register: nfs_utils_check
      changed_when: false
      failed_when: nfs_utils_check.rc != 0

    # --- 5.2 Check mounts ---
    - name: "[02-client] Get current NFS mounts"
      ansible.builtin.shell: mount -t nfs,nfs4 | grep -E '(home|proj|soft)' || true
      register: nfs_mounts_output
      changed_when: false

    - name: "[02-client] Get mount details"
      ansible.builtin.command: cat /proc/mounts
      register: proc_mounts
      changed_when: false

    # --- 5.3 Verify expected mounts (based on nfs_mounts var) ---
    - name: "[02-client] Verify NFS mounts are active"
      ansible.builtin.assert:
        that:
          - "item.path in proc_mounts.stdout"
        fail_msg: "{{ item.path }} is not mounted on {{ inventory_hostname }}"
      loop: "{{ nfs_mounts | default([]) }}"
      loop_control:
        label: "{{ item.path }}"

    # --- 5.4 Verify fstab entries ---
    - name: "[02-client] Get fstab content"
      ansible.builtin.command: cat /etc/fstab
      register: fstab_content
      changed_when: false

    - name: "[02-client] Verify fstab has NFS entries"
      ansible.builtin.assert:
        that:
          - "item.path in fstab_content.stdout"
        fail_msg: "{{ item.path }} missing from /etc/fstab"
      loop: "{{ nfs_mounts | default([]) }}"
      loop_control:
        label: "{{ item.path }}"

    # --- 5.5 Test read access ---
    - name: "[02-client] Test read /proj/.nfs_test_marker"
      ansible.builtin.stat:
        path: /proj/.nfs_test_marker
      register: proj_marker
      when: "'/proj' in (nfs_mounts | default([]) | map(attribute='path') | list)"

    - name: "[02-client] Assert /proj is readable"
      ansible.builtin.assert:
        that:
          - proj_marker.stat.exists
        fail_msg: "/proj NFS mount not readable - marker file missing"
      when: proj_marker is defined and proj_marker.stat is defined

    - name: "[02-client] Test read /soft/.nfs_test_marker"
      ansible.builtin.stat:
        path: /soft/.nfs_test_marker
      register: soft_marker
      when: "'/soft' in (nfs_mounts | default([]) | map(attribute='path') | list)"

    - name: "[02-client] Assert /soft is readable"
      ansible.builtin.assert:
        that:
          - soft_marker.stat.exists
        fail_msg: "/soft NFS mount not readable - marker file missing"
      when: soft_marker is defined and soft_marker.stat is defined

    # --- 5.6 Test write access (only on rw mounts) ---
    - name: "[02-client] Test write to /proj"
      ansible.builtin.file:
        path: "/proj/.nfs_write_test_{{ inventory_hostname }}"
        state: touch
        mode: '0644'
      when: "'/proj' in (nfs_mounts | default([]) | map(attribute='path') | list)"
      register: proj_write_test
      failed_when: false

    - name: "[02-client] Clean up write test file"
      ansible.builtin.file:
        path: "/proj/.nfs_write_test_{{ inventory_hostname }}"
        state: absent
      when: proj_write_test is defined and proj_write_test is not failed
      failed_when: false

    # --- 5.7 Verify NFS version ---
    - name: "[02-client] Check NFS mount version"
      ansible.builtin.shell: nfsstat -m 2>/dev/null | head -20 || mount -t nfs,nfs4
      register: nfs_version_check
      changed_when: false
      failed_when: false

    # --- 5.8 Summary ---
    - name: "[02-client] Display NFS client summary"
      ansible.builtin.debug:
        msg:
          - "═══════════════════════════════════════"
          - "  02-STORAGE NFS CLIENT: {{ inventory_hostname }}"
          - "═══════════════════════════════════════"
          - "  ✓ nfs-utils: installed"
          - "  ✓ Mounted shares:"
          - "{{ nfs_mounts_output.stdout_lines | default(['    (none)']) | to_nice_yaml }}"
          - "  ✓ fstab: entries present"
          - "  ✓ Read test: OK"


##############################################################################
# PART 6: Verify User Privacy & Permissions (storage)
##############################################################################
- name: "99 - Verify User Privacy & Permissions on Storage"
  hosts: storage
  gather_facts: true
  become: true
  tags:
    - privacy
    - permissions

  tasks:
    # --- 6.1 Verify /home structure and permissions ---
    - name: "[privacy] Verify /home exists with correct permissions"
      ansible.builtin.stat:
        path: /home
      register: home_dir

    - name: "[privacy] Assert /home is 755"
      ansible.builtin.assert:
        that:
          - home_dir.stat.exists
          - home_dir.stat.isdir
          - home_dir.stat.mode == '0755'
          - home_dir.stat.pw_name == 'root'
          - home_dir.stat.gr_name == 'root'
        fail_msg: "/home permissions incorrect. Expected 755 root:root, got {{ home_dir.stat.mode }} {{ home_dir.stat.pw_name }}:{{ home_dir.stat.gr_name }}"

    # --- 6.2 Verify shared directories ---
    - name: "[privacy] Verify shared directories exist"
      ansible.builtin.stat:
        path: "/home/{{ item }}"
      register: shared_dirs
      loop:
        - tools
        - software
        - docs

    - name: "[privacy] Assert shared directories are 755 root:root"
      ansible.builtin.assert:
        that:
          - item.stat.exists
          - item.stat.isdir
          - item.stat.mode == '0755'
          - item.stat.pw_name == 'root'
          - item.stat.gr_name == 'root'
        fail_msg: "Shared directory {{ item.item }} permissions incorrect"
      loop: "{{ shared_dirs.results }}"
      loop_control:
        label: "/home/{{ item.item }}"

    # --- 6.3 Verify group directories ---
    - name: "[privacy] Verify group directories exist"
      ansible.builtin.stat:
        path: "/home/{{ item.name }}"
      register: group_dirs
      loop: "{{ user_groups }}"
      loop_control:
        label: "{{ item.name }}"

    - name: "[privacy] Assert group directories are 711 root:groupname"
      ansible.builtin.assert:
        that:
          - item.stat.exists
          - item.stat.isdir
          - item.stat.mode == '0711'
          - item.stat.pw_name == 'root'
          - item.stat.gr_name == item.item.name
        fail_msg: "Group directory /home/{{ item.item.name }} permissions incorrect. Expected 711 root:{{ item.item.name }}"
      loop: "{{ group_dirs.results }}"
      loop_control:
        label: "/home/{{ item.item.name }}"

    # --- 6.4 Check sample user home directories if they exist ---
    - name: "[privacy] Check if sample users exist"
      ansible.builtin.command: getent passwd
      register: all_users
      changed_when: false

    - name: "[privacy] Verify user home directories (if exist)"
      ansible.builtin.shell: |
        for group in lecture stu guest; do
          if [ -d /home/$group ]; then
            for userdir in /home/$group/*/; do
              if [ -d "$userdir" ]; then
                user=$(basename "$userdir")
                mode=$(stat -c '%a' "$userdir")
                owner=$(stat -c '%U' "$userdir")
                group_name=$(stat -c '%G' "$userdir")
                if [ "$mode" != "700" ] || [ "$owner" != "$user" ] || [ "$group_name" != "$group" ]; then
                  echo "FAIL: $userdir has mode=$mode owner=$owner:$group_name (expected 700 $user:$group)"
                  exit 1
                fi
              fi
            done
          fi
        done
        echo "OK: All user directories have correct permissions (700 owner:group)"
      register: user_dir_check
      changed_when: false
      failed_when: user_dir_check.rc != 0

    - name: "[privacy] Display permissions summary"
      ansible.builtin.debug:
        msg:
          - "═══════════════════════════════════════"
          - "  PRIVACY & PERMISSIONS: {{ inventory_hostname }}"
          - "═══════════════════════════════════════"
          - "  ✓ /home: 755 root:root"
          - "  ✓ Shared directories: 755 root:root (tools, software, docs)"
          - "  ✓ Group directories: 711 root:groupname (users cannot list each other)"
          - "  ✓ User directories: {{ user_dir_check.stdout }}"


##############################################################################
# PART 7: Verify User Privacy Configuration (all nodes)
##############################################################################
- name: "99 - Verify User Privacy Configuration"
  hosts: all
  gather_facts: true
  become: true
  tags:
    - privacy
    - umask

  tasks:
    # --- 7.1 Verify umask configuration files ---
    - name: "[privacy] Verify /etc/profile.d/umask.sh exists"
      ansible.builtin.stat:
        path: /etc/profile.d/umask.sh
      register: umask_profile

    - name: "[privacy] Assert umask.sh exists and contains 0077"
      ansible.builtin.assert:
        that:
          - umask_profile.stat.exists
        fail_msg: "/etc/profile.d/umask.sh not found"
      when: umask_profile is defined

    - name: "[privacy] Verify umask 0077 in /etc/profile.d/umask.sh"
      ansible.builtin.command: grep -q "umask 0077" /etc/profile.d/umask.sh
      changed_when: false
      failed_when: false
      register: umask_profile_check

    - name: "[privacy] Verify umask in /etc/bashrc"
      ansible.builtin.command: grep -q "umask 0077" /etc/bashrc
      changed_when: false
      failed_when: false
      register: umask_bashrc_check

    - name: "[privacy] Verify UMASK in /etc/login.defs"
      ansible.builtin.command: grep -q "UMASK.*077" /etc/login.defs
      changed_when: false
      failed_when: false
      register: umask_login_defs_check

    - name: "[privacy] Display umask configuration status"
      ansible.builtin.debug:
        msg:
          - "═══════════════════════════════════════"
          - "  UMASK CONFIGURATION: {{ inventory_hostname }}"
          - "═══════════════════════════════════════"
          - "  ✓ /etc/profile.d/umask.sh: {{ 'OK' if umask_profile_check.rc == 0 else 'MISSING' }}"
          - "  ✓ /etc/bashrc umask: {{ 'OK' if umask_bashrc_check.rc == 0 else 'MISSING' }}"
          - "  ✓ /etc/login.defs UMASK: {{ 'OK' if umask_login_defs_check.rc == 0 else 'MISSING' }}"


##############################################################################
# PART 8: Verify 05-login-gui (login)
##############################################################################
- name: "99 - Verify 05-login-gui: Login GUI"
  hosts: login
  gather_facts: true
  become: true

  tasks:
    - name: "[05] Verify GUI is enabled"
      ansible.builtin.assert:
        that:
          - gui_enabled | default(false) | bool
        fail_msg: "GUI not enabled on login node"

    - name: "[05] Verify XFCE installed"
      ansible.builtin.command: rpm -q xfce4-session
      register: xfce_pkg
      changed_when: false
      failed_when: xfce_pkg.rc != 0
      when: xfce_enabled | default(true) | bool

    - name: "[05] Verify startxfce4 exists"
      ansible.builtin.command: which startxfce4
      register: xfce_bin
      changed_when: false
      failed_when: xfce_bin.rc != 0
      when: xfce_enabled | default(true) | bool

    - name: "[05] Verify X2Go packages installed"
      ansible.builtin.command: rpm -q x2goserver x2goserver-xsession
      register: x2go_pkg
      changed_when: false
      failed_when: x2go_pkg.rc != 0
      when: x2go_enabled | default(false) | bool

    - name: "[05] Verify /etc/skel/.Xclients exists"
      ansible.builtin.stat:
        path: /etc/skel/.Xclients
      register: xclients_file
      when: xfce_enabled | default(true) | bool

    - name: "[05] Assert /etc/skel/.Xclients present"
      ansible.builtin.assert:
        that:
          - xclients_file.stat.exists
        fail_msg: "/etc/skel/.Xclients missing"
      when: xclients_file is defined and xfce_enabled | default(true) | bool

    - name: "[05] Display login GUI summary"
      ansible.builtin.debug:
        msg:
          - "═══════════════════════════════════════"
          - "  05-LOGIN GUI: {{ inventory_hostname }}"
          - "═══════════════════════════════════════"
          - "  ✓ XFCE: {{ 'installed' if xfce_enabled | default(true) else 'skipped' }}"
          - "  ✓ X2Go: {{ 'installed' if x2go_enabled | default(false) else 'skipped' }}"
          - "  ✓ X11Forwarding: enabled"

    # --- 8.2 Verify resource limits configuration ---
    - name: "[05] Check if login-limits config exists"
      ansible.builtin.stat:
        path: /etc/hpc/login-limits.conf
      register: login_limits_conf

    - name: "[05] Check if apply-limits script exists"
      ansible.builtin.stat:
        path: /usr/local/sbin/hpc-apply-login-limits.sh
      register: apply_limits_script

    - name: "[05] Display resource limits status"
      ansible.builtin.debug:
        msg:
          - "  ✓ Login limits config: {{ 'present' if login_limits_conf.stat.exists else 'not configured' }}"
          - "  ✓ Apply limits script: {{ 'present' if apply_limits_script.stat.exists else 'not configured' }}"


##############################################################################
# PART 9: Verify User Groups & Sudo Rules (head)
##############################################################################
- name: "99 - Verify User Groups & Sudo Rules"
  hosts: head
  gather_facts: true
  become: true

  tasks:
    - name: "[groups] Get Kerberos ticket for verification"
      ansible.builtin.shell: echo "{{ freeipa_admin_password }}" | kinit admin
      changed_when: false
      no_log: true

    # --- 9.1 Verify user groups exist ---
    - name: "[groups] Verify user groups exist in FreeIPA"
      ansible.builtin.command: ipa group-show {{ item.name }}
      register: group_show
      changed_when: false
      failed_when: group_show.rc != 0
      loop: "{{ user_groups }}"
      loop_control:
        label: "{{ item.name }}"

    - name: "[groups] Verify group GIDs"
      ansible.builtin.shell: ipa group-show {{ item.name }} | grep 'GID:' | awk '{print $2}'
      register: group_gids
      changed_when: false
      loop: "{{ user_groups }}"
      loop_control:
        label: "{{ item.name }}"

    - name: "[groups] Assert group GIDs match configuration"
      ansible.builtin.assert:
        that:
          - item.stdout | int == item.item.gid
        fail_msg: "Group {{ item.item.name }} GID mismatch. Expected {{ item.item.gid }}, got {{ item.stdout }}"
      loop: "{{ group_gids.results }}"
      loop_control:
        label: "{{ item.item.name }}"

    # --- 9.2 Verify HBAC rules ---
    - name: "[groups] Verify HBAC rules exist"
      ansible.builtin.command: ipa hbacrule-show hbac-{{ item.name }}
      register: hbac_rules
      changed_when: false
      failed_when: hbac_rules.rc != 0
      loop: "{{ user_groups }}"
      loop_control:
        label: "{{ item.name }}"

    - name: "[groups] Verify HBAC rules are enabled"
      ansible.builtin.assert:
        that:
          - "'Enabled: True' in item.stdout or 'Enabled: TRUE' in item.stdout"
        fail_msg: "HBAC rule hbac-{{ item.item.name }} is not enabled"
      loop: "{{ hbac_rules.results }}"
      loop_control:
        label: "hbac-{{ item.item.name }}"

    # --- 9.3 Verify sudo rules for groups with sudo_access ---
    - name: "[groups] Get sudo rules"
      ansible.builtin.command: ipa sudorule-find
      register: sudo_rules_list
      changed_when: false

    - name: "[groups] Verify sudo rule for lecture group"
      ansible.builtin.command: ipa sudorule-show lecture-sudo
      register: lecture_sudo
      changed_when: false
      failed_when: lecture_sudo.rc != 0
      when: "(user_groups | selectattr('name', 'equalto', 'lecture') | selectattr('sudo_access', 'equalto', true) | list | length > 0)"

    - name: "[groups] Assert lecture-sudo is enabled"
      ansible.builtin.assert:
        that:
          - "'Enabled: True' in lecture_sudo.stdout or 'Enabled: TRUE' in lecture_sudo.stdout"
        fail_msg: "Sudo rule lecture-sudo is not enabled"
      when: lecture_sudo is defined and lecture_sudo.stdout is defined

    - name: "[groups] Display groups verification summary"
      ansible.builtin.debug:
        msg:
          - "═══════════════════════════════════════"
          - "  USER GROUPS VERIFICATION: {{ inventory_hostname }}"
          - "═══════════════════════════════════════"
          - "  ✓ User groups: {{ user_groups | map(attribute='name') | join(', ') }}"
          - "  ✓ Group GIDs: verified"
          - "  ✓ HBAC rules: enabled for all groups"
          - "  ✓ Sudo rules: lecture-sudo enabled"


##############################################################################
# PART 10: Final Summary
##############################################################################
- name: "99 - Verify: Final Summary"
  hosts: localhost
  gather_facts: false

  tasks:
    - name: "[SUMMARY] Display final verification status"
      ansible.builtin.debug:
        msg:
          - ""
          - "╔═══════════════════════════════════════════════════════════════╗"
          - "║           VERIFICATION COMPLETE - ALL CHECKS PASSED           ║"
          - "╠═══════════════════════════════════════════════════════════════╣"
          - "║  00-bootstrap: OS baseline configured on all hosts            ║"
          - "║  01-identity:  FreeIPA server running on head01               ║"
          - "║  01-identity:  All clients enrolled and SSSD configured       ║"
          - "║  02-storage:   NFS server exporting /home, /proj, /soft       ║"
          - "║  02-storage:   All clients mounted NFS shares                 ║"
          - "║  05-login-gui: XFCE/X2Go on login node verified               ║"
          - "║  06-privacy:   Permissions verified on storage node           ║"
          - "║  07-privacy:   Umask configuration applied to all nodes       ║"
          - "║  08-groups:    User groups and HBAC/sudo rules verified       ║"
          - "╠═══════════════════════════════════════════════════════════════╣"
          - "║  Privacy & Permissions:                                       ║"
          - "║    /home           - 755 root:root (shared access)            ║"
          - "║    /home/tools     - 755 root:root (shared - all users)       ║"
          - "║    /home/software  - 755 root:root (shared - all users)       ║"
          - "║    /home/docs      - 755 root:root (shared - all users)       ║"
          - "║    /home/lecture   - 770 root:lecture (group isolation)       ║"
          - "║    /home/stu       - 770 root:stu (group isolation)           ║"
          - "║    /home/guest     - 770 root:guest (group isolation)         ║"
          - "║    Umask: 077 (new files 600, new dirs 700)                   ║"
          - "╠═══════════════════════════════════════════════════════════════╣"
          - "║  User Groups:                                                 ║"
          - "║    lecture (10001) - Sudo: ✓  Compute: ✓  Limits: 8C/16GB   ║"
          - "║    stu     (10002) - Sudo: ✗  Compute: ✓  Limits: 4C/8GB    ║"
          - "║    guest   (10003) - Sudo: ✗  Compute: ✗  Limits: 2C/4GB    ║"
          - "╠═══════════════════════════════════════════════════════════════╣"
          - "║  NFS Shares:                                                  ║"
          - "║    /home - User home directories (rw)                         ║"
          - "║    /proj - Project data (rw)                                  ║"
          - "║    /soft - Shared applications (ro on clients)                ║"
          - "╠═══════════════════════════════════════════════════════════════╣"
          - "║  Next steps:                                                  ║"
          - "║    - Run 03-slurm-head.yml for Slurm controller               ║"
          - "║    - Run 04-slurm-compute.yml for compute nodes               ║"
          - "║    - Test privacy: ssh student01@login01 and verify umask     ║"
          - "║    - Create users via create-hpc-user.sh script               ║"
          - "╚═══════════════════════════════════════════════════════════════╝"
          - ""
