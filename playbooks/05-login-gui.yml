---

- name: 05 - Login GUI (XFCE + X2Go)
  hosts: login
  gather_facts: true
  become: true

  pre_tasks:
    - name: Verify network connectivity
      ansible.builtin.ping:

    - name: Validate GUI is enabled
      ansible.builtin.assert:
        that:
          - gui_enabled | default(false) | bool
        fail_msg: "GUI not enabled for this host (set gui_enabled: true)"

  tasks:
    - name: Install EPEL repository
      ansible.builtin.dnf:
        name: epel-release
        state: present

    - name: Enable PowerTools repository
      ansible.builtin.command: dnf config-manager --set-enabled powertools
      changed_when: false

    - name: Install Xorg base packages
      ansible.builtin.dnf:
        name:
          - xorg-x11-server-Xorg
          - xorg-x11-xauth
          - xorg-x11-fonts-Type1
          - xorg-x11-fonts-misc
          - xorg-x11-fonts-75dpi
          - xorg-x11-fonts-100dpi
          - dejavu-sans-fonts
          - dejavu-serif-fonts
          - liberation-fonts
          - dbus-x11
        state: present

    - name: Install XFCE desktop packages
      ansible.builtin.dnf:
        name:
          - xfce4-session
          - xfce4-panel
          - xfce4-settings
          - xfce4-terminal
          - xfce4-appfinder
          - xfce4-screenshooter
          - xfdesktop
          - xfwm4
          - thunar
          - thunar-volman
          - file-roller
          - firefox
          - gedit
          - evince
          - network-manager-applet
        state: present
      when: xfce_enabled | default(true) | bool

    - name: Install X2Go server packages
      ansible.builtin.dnf:
        name:
          - x2goserver
          - x2goserver-xsession
        state: present
      when: x2go_enabled | default(true) | bool
      register: x2go_install_result

    - name: Display X2Go installation status
      ansible.builtin.debug:
        msg: "X2Go install {{ 'succeeded' if x2go_install_result is succeeded else 'FAILED - will use SSH X11 forwarding only' }}"
      when: x2go_enabled | default(true) | bool

    - name: Create global XFCE session launcher
      ansible.builtin.copy:
        dest: /etc/skel/.Xclients
        content: |
          #!/bin/bash
          exec /usr/bin/startxfce4
        owner: root
        group: root
        mode: '0755'
      when: xfce_enabled | default(true) | bool

    - name: Ensure X2Go Xsession script
      ansible.builtin.copy:
        dest: /etc/x2go/Xsession
        content: |
          #!/bin/bash
          if [ -x ~/.Xclients ]; then
              exec ~/.Xclients
          elif [ -x /etc/skel/.Xclients ]; then
              exec /etc/skel/.Xclients
          else
              exec /usr/bin/startxfce4
          fi
        owner: root
        group: root
        mode: '0755'
      when: x2go_enabled | default(true) | bool

    - name: Ensure multi-user target
      ansible.builtin.command: systemctl set-default multi-user.target
      changed_when: false

    - name: Ensure X11 forwarding enabled in sshd_config
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?X11Forwarding'
        line: 'X11Forwarding yes'
        state: present
      notify: Restart sshd

    - name: Verify XFCE is installed
      ansible.builtin.command: which startxfce4
      register: xfce_check
      changed_when: false
      when: xfce_enabled | default(true) | bool

  handlers:
    - name: Restart sshd
      ansible.builtin.systemd:
        name: sshd
        state: restarted
